---
title: "GeoMx Dataset and Normalization"
output: html_notebook
---

# Summary 

The purpose of this notebook is to generate the main GeoMx object containing all data collected and perform initial quality control and normalization. 



# 1. Introduction

This analysis is based on the following Bioconductor vignette:

[Analyzing GeoMx-NGS RNA Expression Data with GeomxTools (bioconductor.org)](https://www.bioconductor.org/packages/release/workflows/vignettes/GeoMxWorkflows/inst/doc/GeomxTools_RNA-NGS_Analysis.html#5_Normalization)

Griswold M, Reeves J, Divakar P, Ortogero N, Yang Z, Zimmerman S, Vitancol R, David H (2023). GeoMxWorkflows: GeoMx Digital Spatial Profiler (DSP) data analysis workflows. doi:10.18129/B9.bioc.GeoMxWorkflows, R package version 1.8.0, https://bioconductor.org/packages/GeoMxWorkflows.


We analyze four different anatomical regions of the Fallopian tube, from most proximal to most distal: isthmus, ampulla, infundibulum, and fimbria. 

Slides are stained for markers of Ciliated (FOXJ1) and Secretory (PAX8) cells and regions of interest are segmented based on these markers. 

This script takes input files (dccs, annotations, and pkc files) and creates a GeoMx Data object. It then performs several filtering and quality control steps following the recommendations provided by Nanostring. Finally, the output is normalized to create the final dataset. 


# 1.1 Required Packages

Run the following script to install packages as needed. If asked to make further installations, type y for "yes" or "a" for all updates, as needed.


```{r}

if (!require("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

# # The following initializes most up to date version of Bioc
BiocManager::install()

BiocManager::install("NanoStringNCTools")
BiocManager::install("GeomxTools")
BiocManager::install("GeoMxWorkflows")

# Note:
# Need to install package lme4, numderiv
library(NanoStringNCTools)
library(GeomxTools)
library(GeoMxWorkflows)

if(packageVersion("GeomxTools") < "2.1" & 
   packageVersion("GeoMxWorkflows") >= "1.0.1"){
    stop("GeomxTools and Workflow versions do not match. Please use the same version. 
    This workflow is meant to be used with most current version of packages. 
    If you are using an older version of Bioconductor please reinstall GeoMxWorkflows and use vignette(GeoMxWorkflows) instead")
}

if(packageVersion("GeomxTools") > "2.1" & 
   packageVersion("GeoMxWorkflows") <= "1.0.1"){
    stop("GeomxTools and Workflow versions do not match. 
         Please use the same version, see install instructions above.")
    
    # to remove current package version
        # remove.packages("GeomxTools")
        # remove.packages("GeonMxWorkflows")
    # see install instructions above 
}


```



```{r}

# create tables
library(knitr)

# general data manipulation
library(tidyverse)


# read in files
library(writexl)
library(here)


# create graphs
library(ggforce)
library(umap)
library(Rtsne)
library(patchwork)


```




## 1.2 Loading Data


Run to create the necessary folder to place documents inside.

```{r}

# Create main folder ("data_input")

ifelse(!dir.exists("all_data_input"), dir.create("all_data_input"), "Folder exists already")


# create subfolders: dccs, pks, annotation

ifelse(!dir.exists("all_data_input/dccs"), dir.create("all_data_input/dccs"), "Folder exists already")

ifelse(!dir.exists("all_data_input/pkcs"), dir.create("all_data_input/pkcs"), "Folder exists already")

ifelse(!dir.exists("all_data_input/annotation"), dir.create("all_data_input/annotation"), "Folder exists already")


```



We need three different types of files to create the initial dataset:

-   DCCs files -- these contain the expression count data and some info about sequencing data from the next gen sequencing platform used.

-   PKCs -- the probe assay metadata, which describes which gene targets are present in the data, find at the following link: [GeoMx DSP Configuration Files \| NanoStringâ¤](https://nanostring.com/products/geomx-digital-spatial-profiler/geomx-dsp-configuration-files/)

    (Do not bother to unzip, place in the appropriate file as is.)

-   Annotation file - this will contain information about the tissue, segment area and nuclei count, and any other info you choose to provide.


We are just going to load all of the dcc files available along with basic annotations for all, then remove unneeded dccs later on.

Now, let's test this to see if we can successfully create the GeoMx dataset object from these files.

```{r}
# 
# The following function takes your directory and appends data_input

datadir <- here::here("all_data_input")

# automatically list files in each directory for use
DCCFiles <- dir(here::here(datadir, "dccs"), pattern = "*.dcc",
                full.names = TRUE, recursive = TRUE)


PKCFiles <- dir(here::here(datadir, "pkcs"), pattern = ".pkc$",
                                full.names = TRUE, recursive = TRUE)

SampleAnnotationFile <- dir(here::here(datadir, "annotation"), pattern = ".xlsx$",
      full.names = TRUE, recursive = TRUE)


```


Testing creation of `readNanoStringGeoMxSet` object. If you get errors saying files are missing or do not have any count info, check to make sure all .dcc files are in the folder (and that you have copied the correct ones).


```{r}

#load data


all_data <-
    readNanoStringGeoMxSet(dccFiles = DCCFiles,
                           pkcFiles = PKCFiles,
                           phenoDataFile = SampleAnnotationFile,
                           phenoDataSheet = "Sheet1", # make sure this matches doc
                           phenoDataDccColName = "Sample_ID",
                           protocolDataColNames = c("aoi", "roi"),
                           experimentDataColNames = c("panel"))

```

Note: The DCC file "DSP-1001660037560-B-A07.dcc" has no counts due to an unresolvable sequencing problem. 

# 2. Study Design

Nanostring recommends checking the PKC files to ensure the expected ones have been loaded.

```{r}

# make sure you loaded knitr using library(knitr)

pkcs <- annotation(all_data)
modules <- gsub(".pkc", "", pkcs)
kable(data.frame(PKCs = pkcs, modules = modules))

```


```{r}
# Rename all_data so we don't mess up the original

preQC_data <- all_data

# Access PhenoData

pheno_data <- pData(all_data)

# We should also simplify patient names

pheno_data <- pheno_data |>
  mutate(
    shortRegion = fct_recode(region, "Amp" = "Ampulla",
                              "Inf" = "Infundibulum",
                              "Fimb" = "Fimbria",
                              "Isth" = "Isthmus"
                              )
    )

# update PhenoData in GeoMx object 

pData(preQC_data) <- pheno_data


#Split into all, disc, and valid



preQC_all <- preQC_data[, pData(preQC_data)$Patient != "P6"]

preQC_discovery <-  preQC_data[, pData(preQC_data)$dataset == "discovery"]

preQC_validation <- preQC_data[, pData(preQC_data)$dataset == "validation"]


```


```{r}

count_mat <- dplyr::count(pData(preQC_data), Patient, region, segment)

kable(count_mat)


```



Save the Completed  Object;

This is the object for all Anatomical studies, before QC, probe merging, or filtering!

```{r}

save(preQC_data, file = "all_preQC.Rdata")

```
